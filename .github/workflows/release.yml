# This workflow is triggered *only* when you push a new tag (e.g., v0.1.6).
# It uses cargo-dist to build all binaries, package them,
# and create a professional GitHub release.
# This single file replaces all the complexity of the previous release.yml.

name: Release with cargo-dist

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*" # Runs on any semver tag like v0.1.0

jobs:
  # This job does everything: builds, packages, and creates the release
  release:
    runs-on: ubuntu-latest
    # Grant permissions for cargo-dist to create the release
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Set up cargo-dist
        # This downloads and installs cargo-dist
        uses: axodotdev/cargo-dist/base-setup@v0.11.1

      - name: Run cargo-dist
        # This is the magic step. It:
        # 1. Builds your app for all configured targets.
        # 2. Packages them into .zip and .tar.gz archives.
        # 3. Creates installer scripts (.sh, .ps1).
        # 4. Generates checksums.
        # 5. Creates a beautiful GitHub Release and uploads everything.
        run: cargo dist build --output-format=github
        env:
          # This token is built-in. No PAT is needed!
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
